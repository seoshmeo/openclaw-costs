---
name: cost-tracker
description: This skill should be used when the user asks about "token costs", "how much am I spending", "cost report", "track costs", "cost breakdown", "weekly report", "expensive calls", "save money on tokens", or "optimize costs". It installs a zero-dependency hook that tracks all Anthropic API token usage and generates cost reports with actionable optimization recommendations.
---

# Cost Tracker for OpenClaw

Track token usage across all Anthropic API calls. See which crons, sessions, and contexts consume the most tokens. Get weekly cost reports with optimization recommendations.

## What this skill does

1. Installs a `globalThis.fetch` hook that intercepts all Anthropic API calls
2. Logs token counts (input, output, cache read, cache write) to a JSONL file
3. Provides CLI commands for cost analytics (summary, top spenders, breakdown, alerts)
4. Generates weekly Telegram-friendly reports with detected issues and estimated savings

## Installation

Run the install script bundled with this skill:

```bash
bash {{skill_dir}}/install.sh
```

This copies the hook and report tool into `~/.openclaw/cost-tracker/`.

Then add the hook to the gateway startup. For Docker Compose, set the environment variable:

```yaml
environment:
  - NODE_OPTIONS=--import /home/openclaw/.openclaw/cost-hook.mjs --max-old-space-size=768
```

For direct execution:

```bash
export NODE_OPTIONS="--import ~/.openclaw/cost-hook.mjs"
openclaw gateway
```

Restart the gateway. Verify by checking logs for: `[openclaw-costs] Token tracking active`

## Generating reports

All reports are generated by running the report script:

```bash
node ~/.openclaw/cost-tracker/cost-report.mjs [command] [options]
```

### Available commands

| Command | Description |
|---------|-------------|
| *(none)* | Summary + top contexts (default) |
| `summary` | Overall cost summary with model breakdown |
| `top` | Top contexts ranked by cost |
| `breakdown <ctx>` | Detailed breakdown for a specific context |
| `alerts` | Calls exceeding cost threshold |
| `hourly` | Hourly usage pattern (ASCII chart) |
| `tail` | Most recent calls |
| `report` | Weekly Telegram report with issues and savings |
| `contexts` | List all detected context names |

### Options

| Option | Default | Description |
|--------|---------|-------------|
| `--days=N` | 7 | Lookback period in days |
| `--limit=N` | 15 | Maximum rows to display |
| `--threshold=N` | 0.10 | Alert threshold in USD |

## Weekly Telegram report

To set up automatic weekly reports, create a cron job that runs the `report` command and sends the output via Telegram:

```
Create a weekly cron that runs: node ~/.openclaw/cost-tracker/cost-report.mjs report
Send the output to the user via Telegram. Schedule for Monday 10:00.
```

The report includes:
- Total calls and estimated cost for the period
- Top 5 spenders by context
- Detected issues (compaction loops, wrong model for task, expensive single calls)
- Estimated savings if issues are fixed

## What it detects

- **Compaction loops** — sessions stuck in summarize-expand cycles burning 100K+ tokens per call
- **Wrong model for the job** — Sonnet used for simple monitoring/digest tasks where Haiku costs 10x less
- **Expensive single calls** — individual calls over $0.50 (usually compaction or oversized context)
- **Cost distribution** — which crons and sessions consume the most budget

## Data storage

All data is stored at `~/.openclaw/cost-tracker/calls.jsonl`. Each line is a JSON object:

```json
{"ts":1740500000,"model":"claude-sonnet-4-5-20250929","ctx":"cron:Gmail Digest","input_tokens":100,"output_tokens":500,"cache_read":8000,"cache_write":0,"cost":0.0083,"latency_ms":3500,"stream":true}
```

The file auto-rotates at 50MB. No database, no external services, no extra processes.

## Model optimization guide

Not all crons need Sonnet. Some tasks are simple enough for Haiku (12x cheaper). But switching blindly breaks quality — test incrementally and monitor.

### Safe for Haiku (tested, quality OK)

| Cron | Why Haiku works |
|------|----------------|
| Jobs Monitor | Simple listing/filtering, no analysis needed |
| Reddit Monitor | Summarize posts, no deep reasoning |
| Greek Morning Flashcards | Generate vocab cards from a fixed pattern |

### Keep on Sonnet (tested, Haiku degrades quality)

| Cron | Why Sonnet needed |
|------|-------------------|
| *(add entries as you test)* | |

### Not yet tested

| Cron | Risk level |
|------|-----------|
| Gmail Digest | Low — mostly summarization |
| Product Hunt | Low — list + brief commentary |
| Moltbook Monitor | Medium — needs to pick relevant posts |
| r/SEO Daily Digest | Medium — analytical |
| Greek Lesson Evening | High — interactive teaching |
| Nightly Reflection | High — analytical reasoning |
| Weekly SEO Deep Dive | High — deep analysis |

### How to switch a cron's model

Edit `sessions.json` inside the container and change the `model` field for the target session:

```bash
docker exec openclaw node -e "
const fs = require('fs');
const p = '/home/openclaw/.openclaw/agents/main/sessions/sessions.json';
const d = JSON.parse(fs.readFileSync(p, 'utf-8'));
const sessions = d.sessions || d;
for (const [k, v] of Object.entries(sessions)) {
  if ((v.label || '').includes('TARGET_CRON_NAME')) {
    v.model = 'claude-haiku-4-5-20251001';  // or claude-sonnet-4-5-20250929
  }
}
fs.writeFileSync(p, JSON.stringify(d));
"
docker restart openclaw
```

## Pricing reference

| Model | Input | Output | Cache Write | Cache Read |
|-------|-------|--------|-------------|------------|
| Sonnet 4.5 | $3/MTok | $15/MTok | $3.75/MTok | $0.30/MTok |
| Opus 4 | $15/MTok | $75/MTok | $18.75/MTok | $1.50/MTok |
| Haiku 4.5 | $0.80/MTok | $4/MTok | $1/MTok | $0.08/MTok |
